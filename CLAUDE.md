# Nightfall

A persistent, shared, city-scale infrastructure sim where real-world GERS infrastructure features (powered by Overture data) are the game objects. Players collaborate via a vector map UI to maintain roads and buildings against The Rust — a creeping decay that spreads faster when night falls.

Tagline: *"The nights are getting longer."*

## Project Structure

Monorepo with pnpm workspaces:

- `apps/web` — Next.js App Router frontend (MapLibre GL, Tailwind, Zustand)
- `apps/api` — Fastify API server with SSE for realtime updates
- `apps/ticker` — Node.js tick worker (game loop, decay, resource generation)
- `packages/pathfinding` — Shared A* pathfinding library for road graph traversal
- `packages/nightfall-ingest` — Data ingest pipeline (Overture → Postgres)

## Quick Commands

```bash
pnpm install          # Install all dependencies
pnpm dev              # Run web, api, and ticker concurrently
pnpm build            # Build all packages
pnpm lint             # Lint all packages
pnpm test             # Run all tests (db + unit + UI)
pnpm test:unit        # Run unit tests only
pnpm test:ui          # Run Playwright tests

# Database
pnpm db:up            # Run migrations
pnpm db:down          # Rollback last migration
pnpm db:status        # Check migration status

# Demo data
pnpm ingest:demo      # Ingest demo region (Bar Harbor, ME)
```

## Key Game Mechanics

- **Day/night cycle**: 20-minute real-time cycle (8 min day, 8 min night, 2 min transitions)
- **The Rust**: Spatial decay spreading from map edges; accelerates at night
- **Resources**: Labor and Materials generated by buildings, transferred to region hubs
- **Crews**: NPC workers that repair degraded roads based on task priority and votes
- **Tasks**: Auto-spawned for degraded roads; players vote to influence priority

## Engineering Practices

- Always add or update tests alongside behavior changes. If a change is hard to test, document why and add a follow-up task.
- Run the full test suite before shipping: `pnpm test` (db + unit + UI).
- Keep migrations additive and reversible; avoid destructive changes without explicit review.
- Prefer small, focused PRs that include code, tests, and any necessary docs.
- When touching API behavior, update `scripts/check-db.mjs` or relevant test fixtures as needed.
- This runs on a very small machine (low CPU + memory); design for minimal resource usage and avoid heavy in-memory caches or background work.

## Common Pitfalls

**Security:**
- Never use `NEXT_PUBLIC_` prefix for secrets — these are bundled into client JavaScript. Use server-side environment variables only.

**React hooks:**
- Async operations in useEffect must track mounted state to prevent state updates on unmounted components
- Include all referenced variables in useEffect/useCallback/useMemo dependency arrays
- Effects with timers, subscriptions, or event listeners need cleanup functions

**Database:**
- Verify `result.rowCount` after UPDATE/DELETE to confirm expected rows were affected
- Import shared constants from `packages/config` instead of hardcoding values

**Accessibility:**
- Interactive elements need keyboard handlers (onKeyDown) and ARIA attributes

## Database

PostgreSQL with PostGIS. Key tables:
- `regions` — Fixed neighborhood divisions
- `hex_cells` — H3 hexagons for Rust mechanics
- `world_features` — Static Overture features (roads, buildings)
- `feature_state` — Dynamic road health/status
- `tasks` — Repair tasks with voting
- `crews` — NPC workers per region
- `resource_transfers` — In-transit resources
- `events` — Activity log for SSE feed

## API Patterns

- SSE endpoint at `/api/stream` for realtime updates
- All responses use `Cache-Control: no-store`
- Ticker uses Postgres advisory locks to prevent duplicate processing

## Environment Variables

Required:
- `DATABASE_URL` — Postgres connection string
- `ADMIN_SECRET` — Secret for admin endpoints (demo mode, reset)

See implementation-spec.md for full API documentation and game mechanics details.
